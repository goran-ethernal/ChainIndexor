name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout 5m

  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        run: go test ./... -v -race -coverprofile=coverage.out -coverpkg=./...

      - name: Generate coverage summary
        run: |
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | grep -v "mocks" | awk '
            BEGIN {
              print sprintf("%-70s %10s", "File", "Coverage");
              print "--------------------------------------------------------------------------------";
            }
            /.go:/ {
              split($1, parts, ":");
              file = parts[1];
              if (!(file in files)) {
                files[file] = 1;
                cmd = "go tool cover -func=coverage.out | grep \"" file ":\" | grep -v mocks | awk \"{sum+=\\$NF; gsub(/%/, \\\"\\\", \\$NF); total+=\\$NF; count++} END {if(count>0) print total/count; else print 0}\"";
                cmd | getline result;
                close(cmd);
                if (result >= 90) marker = " âœ…";
                else if (result >= 70) marker = " âœ“";
                else if (result < 50) marker = " âš ï¸";
                else marker = "";
                printf("%-70s %9.1f%%%s\n", file, result, marker);
              }
            }
          ' | sort | tail -25 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep "total:" | awk '{print $3}' | sed 's/%//')
          echo "ðŸ“Š Total coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "::warning::Coverage is below 70% threshold (current: ${COVERAGE}%)"
          else
            echo "âœ… Coverage meets threshold: ${COVERAGE}% (>70%)"
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: github.event_name == 'pull_request'
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true
